<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]--><!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8"><![endif]--><!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9"><![endif]--><!--[if gt IE 8]><!--><html class="no-js">
<!--<![endif]--> <head> <meta charset="UTF-8"> <meta content="text/html; charset=UTF-8" http-equiv="Content-Type"> <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> <title>Use immutable.js in React application – just4fun</title> <meta name="description" content="Zoro's personal blog."> <meta name="keywords" content="immutable, flux"> <!-- Twitter Cards --> <meta name="twitter:card" content="summary"> <meta name="twitter:image" content="https://just4fun.github.io/assets/img/logo_coder.jpg"> <meta name="twitter:title" content="Use immutable.js in React application"> <meta name="twitter:description" content="In previous article, we got a general understanding about Flux architecture. And in Best Practise section, I have mentioned Immutable data which I haven’t take a look yet. Now it’s time to dig into it."> <!-- Open Graph --> <meta property="og:locale" content="en_US"> <meta property="og:type" content="article"> <meta property="og:title" content="Use immutable.js in React application"> <meta property="og:description" content="In previous article, we got a general understanding about Flux architecture. And in Best Practise section, I have mentioned Immutable data which I haven’t take a look yet. Now it’s time to dig into it."> <meta property="og:url" content="https://just4fun.github.io/2015/07/18/use-immutable-js-in-react-application/"> <meta property="og:site_name" content="just4fun"> <meta property="og:image" content="https://just4fun.github.io/assets/img/logo_coder.jpg"> <link rel="canonical" href="https://just4fun.github.io/2015/07/18/use-immutable-js-in-react-application/"> <link href="https://just4fun.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="just4fun Feed"> <!-- Handheld --> <meta name="HandheldFriendly" content="True"> <meta name="MobileOptimized" content="320"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- CSS --> <link rel="stylesheet" href="https://just4fun.github.io/assets/css/main.css"> <!-- JS --> <script src="https://just4fun.github.io/assets/js/modernizr-3.3.1.custom.min.js"></script> <!-- Favicons --> <link rel="apple-touch-icon" href="https://just4fun.github.io/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="72x72" href="https://just4fun.github.io/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="114x114" href="https://just4fun.github.io/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="144x144" href="https://just4fun.github.io/assets/img/favicons/apple-icon-144x144.png"> <link rel="shortcut icon" type="image/png" href="https://just4fun.github.io/favicon.png"> <link rel="shortcut icon" href="https://just4fun.github.io/favicon.ico"> <!-- Background Image --> <style type="text/css">body {background-image:url(https://just4fun.github.io/assets/img/placeholder-big.jpg); background-repeat: no-repeat; background-size: cover; }</style> <!-- Post Feature Image --> </head> <body> <nav id="dl-menu" class="dl-menuwrapper" role="navigation"> <button class="dl-trigger">Open Menu</button> <ul class="dl-menu"> <li><a href="https://just4fun.github.io/">Home</a></li> <li> <a href="#">Posts</a> <ul class="dl-submenu"> <li><a href="https://just4fun.github.io/posts/">All Posts</a></li> <li><a href="https://just4fun.github.io/tags/">All Tags</a></li> </ul> </li> <li><a href="https://just4fun.github.io/projects/">Projects</a></li> <li> <a href="#">About</a> <ul class="dl-submenu"> <li> <img src="https://just4fun.github.io/assets/img/logo_coder.jpg" alt="just4fun photo" class="author-photo"> <h4>just4fun</h4> <p>Zoro's personal blog.</p> </li> <li><a href="https://just4fun.github.io/about/"><span class="btn btn-inverse">Learn More</span></a></li> <li> <a href="mailto:houritsunohikari@gmail.com" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-envelope-square"></i> Email</a> </li> <li> <a href="http://facebook.com/houritsunohikari" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-facebook-square"></i> Facebook</a> </li> <li> <a href="http://instagram.com/houritsunohikari" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-instagram"></i> Instagram</a> </li> <li> <a href="http://github.com/just4fun" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-github"></i> Github</a> </li> <li> <a href="http://www.weibo.com/houritsunohikari" target="_blank" rel="noopener noreferrer"><i class="fa fa-fw fa-weibo"></i> Weibo</a> </li> </ul>
<!-- /.dl-submenu --> </li> </ul>
<!-- /.dl-menu --> </nav><!-- /.dl-menuwrapper --> <!-- Header --> <header class="header" role="banner"> <div class="wrapper animated fadeIn"> <div class="content"> <div class="post-title "> <h1>Use immutable.js in React application</h1> <h4>18 Jul 2015</h4> <p class="reading-time"> <i class="fa fa-clock-o"></i> Reading time ~4 minutes </p>
<!-- /.entry-reading-time --> <a class="btn zoombtn" href="https://just4fun.github.io/posts/"> <i class="fa fa-chevron-left"></i> </a> </div> <p>In <a href="http://just4fun.github.io/hexo-blog/2015/05/12/flux-architecture/">previous article</a>, we got a general understanding about Flux architecture. And in <a href="http://just4fun.github.io/hexo-blog/2015/05/12/flux-architecture/#Best_Practise">Best Practise</a> section, I have mentioned <code class="highlighter-rouge">Immutable data</code> which I haven’t take a look yet. Now it’s time to dig into it.</p> <!-- more --> <h2 id="preliminaries">Preliminaries</h2> <p>If you have experience writing websites with React, you should know React makes use of a <code class="highlighter-rouge">virtual DOM</code>, which is a descriptor of a DOM subtree rendered in the browser. It is important to understand that the result of render is not an actual DOM node. Those are just lightweight JavaScript objects. That’s virtual DOM.</p> <p>When <code class="highlighter-rouge">setState</code> is called, the component rebuilds the virtual DOM for its children. If you call <code class="highlighter-rouge">setState</code> on the root element, then the entire React App is re-rendered. All the components, even if they didn’t change, will have their render method called. This may sound scary and inefficient but in practice, this works fine because we’re not touching the actual DOM.</p> <p>DOM operations are very expensive because modifying the DOM will also apply and calculate CSS styles, layouts. The saved time from unnecessary DOM modification can be longer than the time spent diffing the virtual DOM. This is the secret of React’s virtual DOM.</p> <p>However, the idea of re-rendering an entire subtree of components in response to every state change makes people wonder whether this process negatively impacts performance. That being said, if you want to get a considerable performance boost, you can minimize the number of costly DOM operations required to update the UI.</p> <h2 id="solution">Solution</h2> <p>React provides a component lifecycle function, <code class="highlighter-rouge">shouldComponentUpdate</code>, which is triggered before the re-rendering process starts (virtual DOM comparison and possible eventual DOM reconciliation), giving the developer the ability to short circuit this process. The default implementation of this function returns <code class="highlighter-rouge">true</code>, leaving React to perform the update.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">shouldComponentUpdate</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nextProps</span><span class="p">,</span> <span class="nx">nextState</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>We could easily implement <code class="highlighter-rouge">shouldComponentUpdate</code> for simple props/state structures like bellow:</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">shouldComponentUpdate</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nextProps</span><span class="p">,</span> <span class="nx">nextState</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">nextProps</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> 
      <span class="o">||</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">nextState</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>We could even generalize an implementation based on shallow equality (cause React will invoke this function pretty <strong>OFTEN</strong>, so the implementation has to be <strong>FAST</strong>) and mix it into components. In fact, React already provides such implementation: <a href="https://facebook.github.io/react/docs/pure-render-mixin.html">PureRenderMixin</a>.</p> <h2 id="issue">Issue</h2> <p>So far so good. Unfortunately, there may be two issues if we bring <code class="highlighter-rouge">PureRenderMixin</code> into our App directly.</p> <hr> <blockquote> <p><em>Manage object references carelessly</em></p> </blockquote> <p>I pushed some commits into the demo App mentioned in previous article. One of the commits is adding a functionality <code class="highlighter-rouge">Like</code>, you can click heart icon to like a book. See code <a href="https://github.com/just4fun/classics/commit/c010dc4cbacc021c45594720955a73664b28deec">here</a>.</p> <p><img src="https://user-images.githubusercontent.com/7512625/28053738-97f42330-6644-11e7-9ea6-40b53b349aae.jpg" alt=""></p> <p>In addition, I added <code class="highlighter-rouge">debug</code> module to track which components will be re-render. See code <a href="https://github.com/just4fun/classics/commit/f2915ad12d644f8691ab6ee309b7e8ceb1c9aedf">here</a>.</p> <p>Now I search some books via entering keyword.</p> <p><img src="https://user-images.githubusercontent.com/7512625/28053741-986e5eb6-6644-11e7-9302-06df2deffee3.jpg" alt=""></p> <p>Then I want to like the first book, so I click the heart icon.</p> <p><img src="https://user-images.githubusercontent.com/7512625/28053740-9834ca8e-6644-11e7-8f45-eec6567df6be.jpg" alt=""></p> <p>As you see, all the book items are re-rendered. Since we want to squeeze out performance, then I bring <code class="highlighter-rouge">PreRenderMixin</code>. See code <a href="https://github.com/just4fun/classics/commit/6ff882cd9c4913d92d9c4b7dbfc5e447f1df598e">here</a>.</p> <p>Unfortunately, <strong>NOTHING</strong> happen, neither the like icon nor the Chrome console.</p> <p>The problem is that since the parent and inner components share a reference to the same object <code class="highlighter-rouge">book</code>, when the object gets mutated on onClick function, the prop the inner component had will change. So, when the re-rendering process starts, and <code class="highlighter-rouge">shouldComponentUpdate</code> gets invoked, <code class="highlighter-rouge">this.props.book</code> will be equal to <code class="highlighter-rouge">nextProps.value.book</code>, because in fact, they reference the same object.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">BookItem</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
  
  <span class="na">mixins</span><span class="p">:</span> <span class="p">[</span><span class="nx">PureRenderMixin</span><span class="p">],</span>
  
  <span class="na">render</span><span class="p">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">book</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">book</span><span class="p">;</span>
    <span class="c1">// ...</span>
    <span class="kd">var</span> <span class="nx">like_status</span> <span class="o">=</span> <span class="s1">'glyphicon glyphicon-heart'</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">book</span><span class="p">.</span><span class="nx">isLike</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">like_status</span> <span class="o">+=</span> <span class="s1">' like'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">debug</span><span class="p">(</span><span class="s1">'render &lt;BookItem /&gt;'</span><span class="p">,</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s1">'main-section__book'</span><span class="o">&gt;</span>
        <span class="c1">// ...</span>
        <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s1">'main-section__book-action'</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="nx">span</span> <span class="nx">className</span><span class="o">=</span><span class="p">{</span><span class="nx">like_status</span><span class="p">}</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">_onClick</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">book</span><span class="p">)}</span><span class="o">&gt;&lt;</span><span class="sr">/span</span><span class="err">&gt;
</span>        <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>      <span class="o">&lt;</span><span class="sr">/div</span><span class="err">&gt;
</span>    <span class="p">);</span>
  <span class="p">},</span>
  
  <span class="na">_onClick</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">BookGetActions</span><span class="p">.</span><span class="nx">like</span><span class="p">(</span><span class="nx">book</span><span class="p">);</span> <span class="c1">// the `book` share the same reference with `this.props.book`</span>
  <span class="p">}</span>

<span class="p">});</span>
</code></pre></div></div> <p>To solve this issue, first of all, we should clone another book object to prevent the same reference sharing.</p> <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">_onClick</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">BookGetActions</span><span class="p">.</span><span class="nx">like</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">book</span><span class="p">)));</span> <span class="c1">// a simple way to clone</span>
<span class="p">}</span>
</code></pre></div></div> <p>Then we should find the specific book in book list which is stored in <code class="highlighter-rouge">BookStore</code>, and replace it with the clone one. Code is omitted.</p> <p>Everything seems OK. However, it may bring another issue.</p> <hr> <blockquote> <p><em>complex data structures</em></p> </blockquote> <p>As <a href="https://facebook.github.io/react/docs/pure-render-mixin.html">React doc</a> mentioned, <code class="highlighter-rouge">PureRenderMixin</code> only <strong>SHALLOWLY</strong> compares the objects. If these contain complex data structures, it may produce false-negatives for deeper differences, which will cause re-render even everything between two objects are same.</p> <h2 id="real-solution">Real solution</h2> <p><a href="https://github.com/facebook/immutable-js">Immutable-js</a> is a JavaScript collections library which provides immutable persistent collections. Immutability makes tracking changes cheap; a change will always result in a new object so we <strong>ONLY</strong> need to check if the reference to the object has changed.</p> <p>Immutable data structures provides you a cheap and less verbose way to track changes on objects, which is all we need to implement <code class="highlighter-rouge">shouldComponentUpdate</code>. Therefore, if we model props and state attributes using the abstractions provided by immutable-js we’ll be able to use <code class="highlighter-rouge">PureRenderMixin</code> and get a nice boost in perf. See code <a href="https://github.com/just4fun/classics/commit/ce3474f2b6d40a6a5c6e1e1b3d56681f5ca2b95f">here</a>.</p> <p>Run our App again, and like the first book, then check the Chrome console.</p> <p><img src="https://user-images.githubusercontent.com/7512625/28053739-98231c44-6644-11e7-90a5-f9422ba9ce0c.jpg" alt=""></p> <p>As we expected, only the liked book has been re-rendered. That’s what Immutable-js do for us.</p> <h2 id="references">References</h2> <ul> <li>https://facebook.github.io/react/docs/advanced-performance.html</li> <li>https://facebook.github.io/react/docs/pure-render-mixin.html</li> <li>http://calendar.perfplanet.com/2013/diff/</li> </ul> <div class="entry-meta"> <br> <hr> <span class="entry-tags"><a href="https://just4fun.github.io/tags/#immutable" title="Pages tagged immutable" class="tag"><span class="term">immutable</span></a><a href="https://just4fun.github.io/tags/#flux" title="Pages tagged flux" class="tag"><span class="term">flux</span></a></span> <span class="social-share"> <a href="https://www.facebook.com/sharer/sharer.php?u=https://just4fun.github.io/2015/07/18/use-immutable-js-in-react-application/" title="Share on Facebook" class="tag"> <span class="term"><i class="fa fa-facebook-square"></i> Share</span> </a> <a href="https://twitter.com/intent/tweet?text=https://just4fun.github.io/2015/07/18/use-immutable-js-in-react-application/" title="Share on Twitter" class="tag"> <span class="term"><i class="fa fa-twitter-square"></i> Tweet</span> </a> <a href="https://plus.google.com/share?url=https://just4fun.github.io/2015/07/18/use-immutable-js-in-react-application/" title="Share on Google+" class="tag"> <span class="term"><i class="fa fa-google-plus-square"></i> +1</span> </a> </span> <div style="clear:both"></div> </div> </div> </div> <section id="disqus_thread" class="animated fadeInUp"></section><!-- /#disqus_thread --> </header> <!-- JS --> <script src="https://just4fun.github.io/assets/js/jquery-1.12.0.min.js"></script> <script src="https://just4fun.github.io/assets/js/jquery.dlmenu.min.js"></script> <script src="https://just4fun.github.io/assets/js/jquery.goup.min.js"></script> <script src="https://just4fun.github.io/assets/js/jquery.magnific-popup.min.js"></script> <script src="https://just4fun.github.io/assets/js/jquery.fitvid.min.js"></script> <script src="https://just4fun.github.io/assets/js/scripts.js"></script> <!-- Asynchronous Google Analytics snippet --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-52990380-1', 'auto'); ga('require', 'linkid', 'linkid.js'); ga('send', 'pageview'); </script> <script type="text/javascript"> var disqus_shortname = 'just4fun'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); (function () { var s = document.createElement('script'); s.async = true; s.type = 'text/javascript'; s.src = '//' + disqus_shortname + '.disqus.com/count.js'; (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s); }()); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript> <!-- MathJax --> <script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> </body> </html>
